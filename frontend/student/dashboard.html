<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Dashboard סטודנט</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .cards { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 10px; }
        .card {
            flex: 1 1 250px;
            background: white;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .card i { color: #a5864f; margin-bottom: 10px; }
        .card img { margin-top: 10px; width: 100%; border-radius: 10px; }
        @media (max-width: 768px){
            .cards { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="navbar">
    <a href="dashboard.html">דשבורד</a>
    <a href="faults.html">תקלות נפוצות</a>
    <a href="courses.html">לומדות</a>
    <a href="qna.html">שאלות ותשובות</a>
    <a href="../login.html" onclick="logout()">התנתק</a>
</div>

<div class="container">
    <h2>דשבורד</h2>
    <p>ברוך הבא, <span id="username"></span></p>

    <h3>הודעות ומידע שימושי</h3>
    <div class="cards" id="messagesCards"></div>

    <h3>מי עובד היום</h3>
    <div class="cards" id="driversCards"></div>

    <h3>מיקומי מחלקות</h3>
    <select id="departmentSelect">
        <option value="tech_admin">טכנאים</option>
        <option value="app_admin">אפליקציה</option>
        <option value="call_admin">מוקד</option>
        <option value="sys_admin">סיסטם</option>
    </select>
    <div class="cards" id="locationsCards"></div>
</div>

<script>
    const user = JSON.parse(localStorage.getItem('user'));
    if(!user || user.role!=='student') window.location.href='../login.html';
    document.getElementById('username').textContent = user.username;
    function logout(){ localStorage.removeItem('user'); }

    // --- כוננים יומיים ---
    async function fetchDrivers(){
        const today=new Date().toISOString().split('T')[0];
        const res=await fetch(`http://localhost:5000/drivers/${today}`);
        const data=await res.json();
        const container=document.getElementById('driversCards');
        container.innerHTML='';
        if(data.length===0){
            const li=document.createElement('div');
            li.className='card';
            li.textContent='אין כוננים היום';
            container.appendChild(li);
        }
        data.forEach(d=>{
            const div=document.createElement('div');
            div.className='card';
            div.innerHTML=`<i class="fa fa-user-friends fa-2x"></i><h4>${d.name}</h4><p>${d.date}</p>`;
            container.appendChild(div);
        });
    }
    fetchDrivers();

    // --- הודעות מנהל ---
    async function fetchMessages(){
        const res=await fetch('http://localhost:5000/messages');
        const data=await res.json();
        const container=document.getElementById('messagesCards');
        container.innerHTML='';
        data.forEach(m=>{
            const div=document.createElement('div');
            div.className='card';
            div.innerHTML=`<i class="fa fa-envelope fa-2x"></i>
            <h4>${m.title}</h4>
            <p>${m.content}</p>
            <small>נשלח על ידי: ${m.created_by}</small>`;
            container.appendChild(div);
        });
    }
    fetchMessages();

    // --- מיקומי מחלקות מה-DB ---
    async function fetchLocations(){
        const department=document.getElementById('departmentSelect').value;
        try{
            const res=await fetch(`http://localhost:5000/locations/${department}`);
            const data=await res.json();
            const container=document.getElementById('locationsCards');
            container.innerHTML='';
            if(data.length===0){
                const div=document.createElement('div');
                div.className='card';
                div.textContent='אין מיקומים למחלקה זו';
                container.appendChild(div);
            }
            data.forEach(l=>{
                const div=document.createElement('div');
                div.className='card';
                div.innerHTML=`<h4>${l.title}</h4>
                             <img src="${l.image_url}" alt="${l.title}">`;
                container.appendChild(div);
            });
        } catch(err){
            console.error('Error fetching locations:', err);
        }
    }
    document.getElementById('departmentSelect').addEventListener('change', fetchLocations);
    fetchLocations();

    // --- Refresh אוטומטי כל 30 שניות ---
    setInterval(()=>{
        fetchDrivers();
        fetchMessages();
        fetchLocations();
    },30000);
</script>
</body>
</html>
