<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>הלומדות שלי</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body { font-family: Arial, sans-serif; background:#f9f9f9; }
        .navbar { background:#333; padding:10px; }
        .navbar a { color:white; margin-left:15px; text-decoration:none; }
        .container { max-width: 900px; margin:30px auto; }
        h2 { color:#333; }
        .search-bar {
            margin-bottom:20px;
            display:flex;
            gap:10px;
        }
        .search-bar input {
            flex:1;
            padding:8px;
            border-radius:6px;
            border:1px solid #ccc;
        }
        .search-bar button {
            padding:8px 15px;
            border:none;
            border-radius:6px;
            background:#a5864f;
            color:white;
            cursor:pointer;
        }
        .search-bar button:hover { background:#8b6f40; }
        .course-card {
            background:#fff;
            border-radius:10px;
            padding:15px;
            margin-bottom:20px;
            box-shadow:0 2px 5px rgba(0,0,0,0.1);
        }
        .course-card h3 { margin-top:0; color:#a5864f; }
        .course-card p { margin:5px 0; }
        .course-media { margin-top:10px; }
        iframe, video, img { max-width:100%; border-radius:8px; }
    </style>
</head>
<body>
<div class="navbar">
    <a href="dashboard.html">דשבורד</a>
    <a href="faults.html">תקלות נפוצות</a>
    <a href="courses.html">לומדות</a>
    <a href="qna.html">שאלות ותשובות</a>
    <a href="../login.html" onclick="logout()">התנתק</a>
</div>

<div class="container">
    <h2>הלומדות שלי</h2>

    <!-- חיפוש -->
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="חפש לפי כותרת או תוכן...">
        <button onclick="applySearch()">חפש</button>
    </div>

    <div id="courses"></div>
</div>

<script>
    const user = JSON.parse(localStorage.getItem('user'));
    if(!user) window.location.href='../login.html';
    function logout(){ localStorage.removeItem('user'); }

    let allCourses = [];

    // מיפוי ל-department לפי role
    function getDepartmentByRole(role){
        switch(role){
            case "tech_admin": return "tech";      // טכנאי → רואה רק טכנאים
            case "call_admin": return "call";      // מוקד → רואה רק מוקד
            case "app_admin": return "apps";       // מנהל אפליקציות
            case "sys_admin": return "system";     // מנהל מערכת
            case "student_admin": return "students";
            case "student": return "all";          // סטודנט → רואה הכל
            default: return "students"; // ברירת מחדל
        }
    }

    async function loadCourses(){
        try {
            const department = getDepartmentByRole(user.role);

            let data = [];
            if(department === "all"){
                // סטודנט: מושך את כל הלומדות
                const res = await fetch(`http://localhost:5000/courses`);
                data = await res.json();
            } else {
                // שאר התפקידים: מושכים לפי מחלקה
                const res = await fetch(`http://localhost:5000/courses/${department}`);
                data = await res.json();
            }

            allCourses = data;
            renderCourses(data);
        } catch(err){
            console.error(err);
            alert('שגיאה בטעינת לומדות');
        }
    }

    function renderCourses(courses){
        const container = document.getElementById('courses');
        container.innerHTML = '';

        if(courses.length === 0){
            container.innerHTML = '<p>לא נמצאו לומדות.</p>';
            return;
        }

        courses.forEach(c=>{
            const card = document.createElement('div');
            card.className = 'course-card';
            card.innerHTML = `<h3>${c.title}</h3>
                        ${c.content ? `<p>${c.content}</p>` : ''}`;

            // מדיה / קובץ
            const mediaDiv = document.createElement('div');
            mediaDiv.className = 'course-media';

            if(c.file_url){
                if(c.file_url.endsWith('.pdf')){
                    mediaDiv.innerHTML = `<iframe src="${c.file_url}" width="100%" height="400px"></iframe>`;
                } else if(c.file_url.endsWith('.doc') || c.file_url.endsWith('.docx')){
                    mediaDiv.innerHTML = `<a href="${c.file_url}" target="_blank">📄 הורד קובץ Word</a>`;
                } else if(c.file_url.match(/\.(jpg|jpeg|png|gif)$/)){
                    mediaDiv.innerHTML = `<img src="${c.file_url}" alt="תמונה">`;
                } else if(c.file_url.match(/\.(mp4|webm|ogg)$/)){
                    mediaDiv.innerHTML = `<video controls><source src="${c.file_url}"></video>`;
                } else {
                    mediaDiv.innerHTML = `<a href="${c.file_url}" target="_blank">פתח קובץ</a>`;
                }
            }

            card.appendChild(mediaDiv);
            container.appendChild(card);
        });
    }

    function applySearch(){
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        if(!keyword) return renderCourses(allCourses);

        const filtered = allCourses.filter(c=>
            (c.title && c.title.toLowerCase().includes(keyword)) ||
            (c.content && c.content.toLowerCase().includes(keyword))
        );
        renderCourses(filtered);
    }

    loadCourses();
</script>
</body>
</html>
