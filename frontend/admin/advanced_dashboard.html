<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .container{ max-width:1200px; margin:auto; padding:20px; }
        h2,h3{ color:#a5864f; }
        .cards{ display:flex; flex-wrap:wrap; gap:20px; margin-top:10px; }
        .card{
            flex:1 1 300px; background:white; border-radius:15px;
            padding:15px; box-shadow:0 5px 20px rgba(0,0,0,0.1);
        }
        .card img, .card video{ width:100%; border-radius:10px; margin-top:10px; }
        form{ margin-bottom:20px; }
        form input, form textarea, form select{ width:100%; padding:8px; margin:5px 0; border-radius:8px; border:1px solid #ccc; }
        form button{ padding:10px 20px; border:none; border-radius:8px; background:#a5864f; color:white; cursor:pointer; }
        form button:hover{ background:#8b6f40; }
    </style>
</head>
<body>
<div class="navbar">
    <a href="admin.html">Admin Dashboard</a>
    <a href="../login.html" onclick="logout()">התנתק</a>
</div>

<div class="container">
    <h2>ברוך הבא, <span id="username"></span></h2>

    <!-- 1️⃣ תקלות ממתינות לאישור -->
    <h3>תקלות ממתינות לאישור</h3>
    <div class="cards" id="pendingFaults"></div>

    <!-- 2️⃣ הוספת מיקום מחלקה -->
    <h3>הוספת מיקום מחלקה</h3>
    <form id="locationForm" enctype="multipart/form-data">
        <select id="dept" required>
            <option value="">בחר מחלקה</option>
            <option value="tech">טכנאים</option>
            <option value="app">אפליקציה</option>
            <option value="call">מוקד</option>
            <option value="sys">סיסטם</option>
        </select>
        <input type="text" id="locTitle" placeholder="שם המקום" required>
        <input type="file" id="locImage" accept="image/*">
        <button type="submit">הוסף מיקום</button>
    </form>

    <!-- 3️⃣ הוספת הודעה -->
    <h3>הוספת הודעה חדשה</h3>
    <form id="msgForm">
        <input type="text" id="msgTitle" placeholder="כותרת" required>
        <textarea id="msgContent" placeholder="תוכן ההודעה" required></textarea>
        <button type="submit">שלח הודעה</button>
    </form>

    <!-- 4️⃣ הצגת כוננים לפי תאריך -->
    <h3>כוננים לפי תאריך</h3>
    <input type="date" id="driverDate">
    <button id="fetchDrivers">הצג כוננים</button>
    <ul id="driverList"></ul>
    <form id="driverForm">
        <input type="date" id="newDriverDate" required>
        <input type="text" id="driverName" placeholder="שם כונן" required>
        <button type="submit">הוסף כונן</button>
    </form>

</div>

<script>
    const user = JSON.parse(localStorage.getItem('user'));
    if(!user || !user.role.includes('admin')) window.location.href='../login.html';
    document.getElementById('username').textContent=user.username;
    function logout(){ localStorage.removeItem('user'); }

    // --- 1️⃣ fetch pending faults ---
    async function fetchPendingFaults(){
        const res = await fetch('http://localhost:5000/faults/pending');
        const data = await res.json();
        const container = document.getElementById('pendingFaults');
        container.innerHTML='';
        data.forEach(f=>{
            const div=document.createElement('div');
            div.className='card';
            div.innerHTML=`<h4>${f.issue}</h4>
            <p>${f.solution}</p>
            <small>נשלח על ידי: ${f.username}</small>`;
            if(f.media){
                if(f.media.endsWith('.mp4')) div.innerHTML+=`<video src="http://localhost:5000${f.media}" controls></video>`;
                else div.innerHTML+=`<img src="http://localhost:5000${f.media}" alt="media">`;
            }
            const btn = document.createElement('button');
            btn.textContent='אשר תקלה';
            btn.onclick=async ()=>{
                await fetch(`http://localhost:5000/faults/approve/${f.id}`,{method:'POST'});
                fetchPendingFaults();
            };
            div.appendChild(btn);
            container.appendChild(div);
        });
    }
    fetchPendingFaults();

    // --- 2️⃣ Add location ---
    document.getElementById('locationForm').addEventListener('submit', async e=>{
        e.preventDefault();
        const formData = new FormData();
        formData.append('department', document.getElementById('dept').value);
        formData.append('title', document.getElementById('locTitle').value);
        const file = document.getElementById('locImage').files[0];
        if(file) formData.append('image', file);
        await fetch('http://localhost:5000/locations',{method:'POST',body:formData});
        e.target.reset();
        alert('מיקום נוסף בהצלחה');
    });

    // --- 3️⃣ Add message ---
    document.getElementById('msgForm').addEventListener('submit', async e=>{
        e.preventDefault();
        const title=document.getElementById('msgTitle').value;
        const content=document.getElementById('msgContent').value;
        await fetch('http://localhost:5000/messages',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({title,content,created_by:user.username})
        });
        e.target.reset();
        alert('הודעה נשלחה בהצלחה');
    });

    // --- 4️⃣ Fetch drivers ---
    document.getElementById('fetchDrivers').addEventListener('click', async ()=>{
        const date=document.getElementById('driverDate').value;
        const res=await fetch(`http://localhost:5000/drivers/${date}`);
        const data=await res.json();
        const ul=document.getElementById('driverList');
        ul.innerHTML='';
        data.forEach(d=>{
            const li=document.createElement('li');
            li.textContent=d.name;
            ul.appendChild(li);
        });
    });

    // --- Add new driver ---
    document.getElementById('driverForm').addEventListener('submit', async e=>{
        e.preventDefault();
        const date=document.getElementById('newDriverDate').value;
        const name=document.getElementById('driverName').value;
        await fetch('http://localhost:5000/drivers',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({date,name})
        });
        e.target.reset();
        alert('כונן נוסף בהצלחה');
    });
</script>
</body>
</html>
